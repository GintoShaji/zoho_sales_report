from django.shortcuts import redirect
from django.core.mail import send_mail
from django.conf import settings
from django.contrib import messages
from openpyxl import Workbook
from datetime import date
from django.core.mail import EmailMessage
from io import BytesIO

def shareSalesReportsToEmail(request):
    try:
        if 'login_id' in request.session:
            if request.session.has_key('login_id'):
                log_id = request.session['login_id']
            else:
                return redirect('/')
            
            log_details = LoginDetails.objects.get(id=log_id)
            if log_details.user_type == 'Staff':
                dash_details = StaffDetails.objects.get(login_details=log_details)
                comp_details = CompanyDetails.objects.get(id=dash_details.company.id)
            else:
                dash_details = CompanyDetails.objects.get(login_details=log_details)
                comp_details = CompanyDetails.objects.get(login_details=log_details)
                
            allmodules = ZohoModules.objects.get(company=comp_details,status='New')
            
            sale = SaleOrder.objects.filter(company=comp_details)
            
            if request.method == 'POST':
                emails_string = request.POST['email_ids']
                emails_list = [email.strip() for email in emails_string.split(',')]
                email_message = request.POST['email_message']

                workbook = Workbook()
                worksheet = workbook.active
                worksheet.title = 'Salesorder Reports'

                headers = ['STATUS', 'DATE', 'SHIPMENT DATE', 'SALES ORDER NO', 'CUSTOMER NAME','TOTAL AMOUNT']
                worksheet.append(headers)

                for sel in sale:
                    row_data = [sel.status, sel.sales_order_date, sel.expiration_date, 
                                sel.sales_order_number, f"{sel.customer.first_name} {sel.customer.last_name}", 
                                sel.grand_total]
                    worksheet.append(row_data)

                excelfile = BytesIO()
                workbook.save(excelfile)
                
                mail_subject = f'Salesorder Reports - {date.today()}'
                message = f"Hi,\nPlease find the SALES REPORTS file attached. \n{email_message}\n\n--\nRegards,\n{comp_details.company_name}\n{comp_details.address}\n{comp_details.state} - {comp_details.country}\n"
                message = EmailMessage(mail_subject, message, settings.EMAIL_HOST_USER, emails_list)
                message.attach(f'Salesorder Reports-{date.today()}.xlsx', excelfile.getvalue(), 'application/vnd.ms-excel')
                message.send(fail_silently=False)

                messages.success(request, 'Sales Report has been shared via email successfully.')
                return redirect(Salesorder_report)
    except Exception as e:
        print(e)
        messages.error(request, 'An error occurred while sharing the sales report via email.')
        return redirect(Salesorder_report)